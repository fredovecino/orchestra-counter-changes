<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Counter</title>
    {% include "partials/external_links.nunjucks" %}
</head>

<!-- Imported partials -->
{% import "partials/button.nunjucks" as button  %}

<body>
    <div class="qm-app">
        <!-- Qmatic Header -->
        {% include "partials/global-header.nunjucks" %}
       
        <!-- Qmatic Main -->
        <main class="qm-main">

            <!-- Qmatic Main Left -->
            <div class="qm-main__left">
                <div class="qm-card-layout">
                    {% include "partials/closed-card.nunjucks" %}
                    {# {% include "partials/visit-card.nunjucks" %} #}
                    {# {% include "partials/ds-card.nunjucks" %} #}
                    {# {% include "partials/mark-card.nunjucks" %} #}
                </div>

                <!-- Qmatic Action Bar -->
                {% include "partials/action-bar.nunjucks" %}
            </div>


            <!-- Qmatic Main Right -->
            <div class="qm-main__right">
                {% include "partials/pools.nunjucks" %}
                {% include "partials/queue-tabs.nunjucks" %}
            </div>
        </main>
        <footer class="qm-footer">
            <div class="qm-footer__content">
                {% include "partials/footer.nunjucks" %}
            </div>
        </footer>
    </div>

    <div class="qm-popovers qm-hide" aria-hidden="true">
        {% include "partials/popover-action-bar.nunjucks" %}
    </div>
    <div class=""></div>
    {% include "partials/previous_counter.nunjucks" %}



    <!-- Modal Views -->
    <div id="modal-nav" class="qm-modal-nav">
        {% include "partials/modals/profileSettings/profile-settings.nunjucks" %}
        {% include "partials/modals/noWaitingCustomers/no-waiting-customers.nunjucks" %}
    </div>
    



    <script type="text/javascript">
            $(document).ready(function() {
                // If we ever, ever, end up with a 401, we are either timedout due to inactivity
                // or just plain evil. Anyway we should be logged out.
                $.ajaxSetup( {
                    cache : false,
                    statusCode : {
                        401: function() {
                            location.href = "/logout.jsp";
                        }
                    }
                });

                init.init();

                // Temporary toggle of pools - Move this to a better location and make better implementaion
                $('.qm-pool__toggle-btn').on('click', function (e) {
                    $(this).closest('.qm-pool').toggleClass('qm-pool--is-open');
                });
                
                
                function QmPopover (popTarget, template) {
                    this.template = template;
                    this.target = popTarget;
                };

                QmPopover.prototype = {
                    init: function () {

                        this.instance = new Tooltip(actionPopoverTargets[i], {
                            container: document.body,
                            trigger: 'manual',
                            title: ' ',
                            placement: 'bottom-start',
                            template: this.template,
                            offset: '0, 10'
                        });

                        this._attachTargetEventListeners();
                    },
                    _attachCloseBtnEvent: function () {
                        var closeBtn = this.instance._tooltipNode.querySelector('.tooltip__close');
                        closeBtn.addEventListener('click', this._toggleInstance.bind(this));
                    },
                    _toggleAndAttachClose: function (e) {
                        var shouldAttachCloseEvent = this.instance._tooltipNode ? false : true; 
                        this._toggleInstance(e);

                        if(shouldAttachCloseEvent) {
                            this._attachCloseBtnEvent();
                        }
                    },
                    _attachTargetEventListeners: function () {
                        this.target.addEventListener('click', this._toggleAndAttachClose.bind(this));
                    },
                    _toggleInstance: function (e) {
                        e.preventDefault();
                        this.instance.toggle();
                    }
                }

                // Init Action popovers
                // Ref
                var actionPopoverTargets = document.querySelectorAll('[data-toggle="popover"]');
                // Template
                var actionPopoverTemplate = document.querySelector('.qm-action-popover').outerHTML.trim();

                for(var i = 0; i < actionPopoverTargets.length; i++) {
                    var popover = new QmPopover(actionPopoverTargets[i], actionPopoverTemplate);
                    popover.init();
                }

                // TABS
                var tabConfig = {
                    tabComponentId: 'js-qm-tabs'
                };
                
                window.$Qmatic.components.tabs(tabConfig);
			});
        </script>
</body>

</html>
